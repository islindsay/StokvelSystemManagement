@model StokvelManagementSystem.Models.Member

@{
    ViewData["Title"] = "My Profile";
}

@section Styles {
    <link rel="stylesheet" href="@Url.Content("~/css/registration.css")" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
}

<h2 class="text-center page-title">My Profile</h2>

<div class="card p-4 mx-auto" style="max-width: 900px;">
    <form asp-controller="Profile" asp-action="Index" method="post">
        @Html.AntiForgeryToken()

        <h3 class="form-section-title mb-4">Personal Details</h3>
        <div class="row mb-3">
            <div class="col-md-4">
                <input asp-for="FirstName" class="form-control" placeholder="First Name" />
                <span asp-validation-for="FirstName" class="text-danger"></span>
            </div>
            <div class="col-md-4">
                <input asp-for="MiddleName" class="form-control" placeholder="Middle Name" />
                <span asp-validation-for="MiddleName" class="text-danger"></span>
            </div>
            <div class="col-md-4">
                <input asp-for="LastName" class="form-control" placeholder="Last Name" />
                <span asp-validation-for="LastName" class="text-danger"></span>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <input asp-for="DOB" type="date" class="form-control" />
                <span asp-validation-for="DOB" class="text-danger"></span>
            </div>
            <div class="col-md-4">
                <input asp-for="NationalID" class="form-control" placeholder="National ID" />
                <span asp-validation-for="NationalID" class="text-danger"></span>
            </div>
            <div class="col-md-4">
                <input asp-for="Phone" class="form-control" placeholder="Phone Number" />
                <span asp-validation-for="Phone" class="text-danger"></span>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <input asp-for="Email" type="email" class="form-control" placeholder="Email" />
                <span asp-validation-for="Email" class="text-danger"></span>
            </div>
            <div class="col-md-6">
                <select asp-for="GenderID" asp-items="ViewBag.GenderList" class="form-control">
                    <option value="">-- Select Gender --</option>
                </select>
                <span asp-validation-for="GenderID" class="text-danger"></span>
            </div>
        </div>

        <div class="mb-3">
            <textarea asp-for="Address" class="form-control" rows="3" placeholder="Enter your address"></textarea>
            <span asp-validation-for="Address" class="text-danger"></span>
        </div>

        <h3 class="form-section-title mb-4">Account Details</h3>
        <div class="row mb-3">
            <div class="col-md-4">
                <input asp-for="AccountNumber" id="AccountNumber" class="form-control" placeholder="Account Number" />
                <span asp-validation-for="AccountNumber" class="text-danger"></span>
            </div>
            <div class="col-md-4">
                <input asp-for="CVC" id="CVC" class="form-control" placeholder="CVC" maxlength="4" />
                <span asp-validation-for="CVC" class="text-danger"></span>
            </div>
            <div class="col-md-4">
                <input asp-for="Expiry" id="Expiry" class="form-control" placeholder="MM/YY" />
                <span asp-validation-for="Expiry" class="text-danger"></span>
            </div>
        </div>

        <h3 class="form-section-title mb-4">Login Details</h3>
        <div class="row mb-3">
            <div class="col-md-4">
                <input asp-for="Username" class="form-control" placeholder="Username" />
                <span asp-validation-for="Username" class="text-danger"></span>
            </div>
            <div class="col-md-4">
                <input asp-for="Password" type="password" class="form-control" placeholder="New Password (optional)" />
                <span asp-validation-for="Password" class="text-danger"></span>
            </div>
            <div class="col-md-4">
                <input asp-for="ConfirmPassword" type="password" class="form-control" placeholder="Confirm Password" />
                <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i> Save Changes
            </button>
        </div>
    </form>
</div>

<!-- Modal for Update Status -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateStatusLabel">Profile Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <!-- Placeholders for icon and message -->
                <div id="updateStatusIcon" class="mb-3"></div>
                <div id="updateStatusMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <partial name="_ValidationScriptsPartial" />

<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");
    const accountNumberInput = document.querySelector("#AccountNumber");
    const cvcInput = document.querySelector("#CVC");
    const expiryInput = document.querySelector("#Expiry");

    const accountNumberError = accountNumberInput.nextElementSibling;
    const cvcError = cvcInput.nextElementSibling;
    const expiryError = expiryInput.nextElementSibling;

    function isValidLuhn(number) {
        let sum = 0;
        let shouldDouble = false;
        for (let i = number.length - 1; i >= 0; i--) {
            let digit = parseInt(number[i]);
            if (shouldDouble) {
                digit *= 2;
                if (digit > 9) digit -= 9;
            }
            sum += digit;
            shouldDouble = !shouldDouble;
        }
        return sum % 10 === 0;
    }

    accountNumberInput.addEventListener("input", () => {
        const value = accountNumberInput.value.trim();
        if (value === "" || (/^\d{8,16}$/.test(value) && isValidLuhn(value))) {
            accountNumberInput.setCustomValidity("");
            accountNumberError.textContent = "";
        } else {
            accountNumberInput.setCustomValidity("Invalid Account Number");
            accountNumberError.textContent = "Must be 8-16 digits and pass Luhn check";
        }
    });

    cvcInput.addEventListener("input", () => {
        const value = cvcInput.value.trim();
        if (value === "" || /^\d{3,4}$/.test(value)) {
            cvcInput.setCustomValidity("");
            cvcError.textContent = "";
        } else {
            cvcInput.setCustomValidity("Invalid CVC");
            cvcError.textContent = "CVC must be 3 or 4 digits";
        }
    });

    expiryInput.addEventListener("input", () => {
        const value = expiryInput.value.trim();
        if (value === "") {
            expiryInput.setCustomValidity("");
            expiryError.textContent = "";
            return;
        }
        const match = /^(\d{2})\/(\d{2})$/.exec(value);
        if (match) {
            const month = parseInt(match[1], 10);
            const year = parseInt(match[2], 10) + 2000;
            const expiryDate = new Date(year, month - 1, 1);
            const today = new Date();
            today.setDate(1);
            if (expiryDate >= today && month >= 1 && month <= 12) {
                expiryInput.setCustomValidity("");
                expiryError.textContent = "";
                return;
            }
        }
        expiryInput.setCustomValidity("Invalid Expiry");
        expiryError.textContent = "Expiry must be valid and not in the past";
    });

    form.addEventListener("submit", function (e) {
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
    });

    // Show modal if there's a success or error message
    const successMessage = "@ViewBag.SuccessMessage";
    const errorMessage = "@ViewBag.ErrorMessage";

    if (successMessage || errorMessage) {
        const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
        const iconContainer = document.getElementById('updateStatusIcon');
        const messageContainer = document.getElementById('updateStatusMessage');

        if (successMessage) {
            iconContainer.innerHTML = `
                <div style="width:80px; height:80px; background-color:#28a745; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:auto;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="white" class="bi bi-check2" viewBox="0 0 16 16">
                        <path d="M13.854 3.646a.5.5 0 0 0-.708 0L6 10.793 2.854 7.646a.5.5 0 1 0-.708.708l3.5 3.5a.5.5 0 0 0 .708 0l7.5-7.5a.5.5 0 0 0 0-.708z"/>
                    </svg>
                </div>`;
            messageContainer.textContent = successMessage;
            messageContainer.className = "fs-5 fw-bold text-success text-center";
        } else {
            iconContainer.innerHTML = `
                <div style="width:80px; height:80px; background-color:#dc3545; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:auto;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="white" class="bi bi-x-lg" viewBox="0 0 16 16">
                        <path d="M2.146 2.146a.5.5 0 1 1 .708.708L2.707 3.707 7.5 8.5l-4.793 4.793a.5.5 0 0 1-.708-.708L6.293 8.5 2.146 4.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </div>`;
            messageContainer.textContent = errorMessage;
            messageContainer.className = "fs-5 fw-bold text-danger text-center";
        }

        modal.show();
    }
});
</script>

}
